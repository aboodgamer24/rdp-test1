name: RDP with Cloudflare Tunnel

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Download Cloudflared
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

      - name: Setup RDP
        run: |
          net user kame23 S5316875844@a /add
          net localgroup administrators kame23 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-Service -Name "TermService" -StartupType Automatic
          Start-Service -Name "TermService"
          Start-Sleep -Seconds 10

      - name: Start Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # Start tunnel with token
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--no-autoupdate", "run", "--token", "$env:TUNNEL_TOKEN" -NoNewWindow -RedirectStandardOutput tunnel.log
          
          Start-Sleep -Seconds 15
          
          Write-Host "=========================================="
          Write-Host "Cloudflare Tunnel Started!"
          Write-Host "=========================================="
          Write-Host "Connect to your configured hostname"
          Write-Host "Username: kame23"
          Write-Host "Password: S5316875844@a"
          Write-Host "=========================================="
          
          Get-Content tunnel.log

      - name: Keep alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active: $(Get-Date)"
            if (-not (Get-Process cloudflared -ErrorAction SilentlyContinue)) {
              Write-Host "Restarting tunnel..."
              Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "run", "--token", "$env:CLOUDFLARE_TUNNEL_TOKEN" -NoNewWindow
            }
          }
